<article class="glass-card border border-slate-200 h-full min-h-0 flex flex-col overflow-hidden">
  <header class="px-6 xl:px-8 py-6 border-b border-slate-200 flex flex-wrap lg:flex-nowrap items-start justify-between gap-4">
    <div class="space-y-2">
      <h2 class="text-2xl font-semibold text-slate-900">AI Agent and Human Agent</h2>
      <p class="text-sm text-slate-500">{{ humanAgentName }}</p>
    </div>
  </header>

  <div class="flex-1 min-h-0 flex flex-col overflow-hidden">
  <div class="flex-1 min-h-0 flex flex-col overflow-y-auto px-3 py-4 muted-scrollbar" style="overscroll-behavior: contain; -webkit-overflow-scrolling: touch;">
      @if (!showAgentPanel) {
        <div class="rounded-3xl border border-dashed border-slate-200 bg-white/70 px-5 py-6 text-center text-sm text-slate-500">
          The agent panel will populate once a transfer occurs.
        </div>
      } @else {
        <div class="agent-panel__body" [class.agent-panel__body--collapsed]="sidebarCollapsed">
          <aside class="agent-panel__sidebar" [class.agent-panel__sidebar--collapsed]="sidebarCollapsed">
            <h3 class="agent-panel__sidebar-title">Workspace</h3>
            <nav class="agent-panel__nav">
              <button
                type="button"
                class="agent-panel__nav-button"
                [class.agent-panel__nav-button--active]="showAgentSummary"
                (click)="toggleSummary.emit()"
              >
                <span class="agent-panel__nav-label">Case Summary</span>
              </button>
              <button
                type="button"
                class="agent-panel__nav-button"
                [class.agent-panel__nav-button--active]="showAgentHistory"
                (click)="toggleHistory.emit()"
              >
                <span class="agent-panel__nav-label">Customer Conversation with AI</span>
              </button>
              <button
                type="button"
                class="agent-panel__nav-button"
                [class.agent-panel__nav-button--active]="showAgentAiChat"
                (click)="toggleAgentAiChat.emit()"
              >
                <span class="agent-panel__nav-label">Human Agent and AI Chat</span>
              </button>
            </nav>
          </aside>

          <section class="agent-panel__content">
            <div class="agent-panel__content-header">
              <button
                type="button"
                class="agent-panel__collapse"
                (click)="toggleSidebar()"
                [attr.aria-expanded]="!sidebarCollapsed"
                [attr.aria-label]="sidebarCollapsed ? 'Show workspace' : 'Hide workspace'"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="none"
                  class="agent-panel__collapse-icon"
                  [attr.data-collapsed]="sidebarCollapsed"
                >
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m15 19-7-7 7-7" />
                </svg>
              </button>
              <h3 class="agent-panel__section-title">{{ activeWorkspaceTitle }}</h3>
            </div>
            @if (showAgentSummary) {
              <div class="agent-panel__section">
                <div class="agent-panel__section-body">
                  @if (agentTransferSummary) {
                    <p class="agent-panel__summary-text">{{ agentTransferSummary }}</p>
                  } @else {
                    <p class="agent-panel__summary-empty">No summary provided.</p>
                  }
                </div>
              </div>
            } @else if (showAgentHistory) {
              <div class="agent-panel__section agent-panel__section--scrollable">
                <div class="agent-panel__timeline muted-scrollbar">
                  @if (!agentThread.length) {
                    <div class="agent-panel__empty">The customer conversation will appear here after a transfer.</div>
                  } @else {
                    @for (message of agentThread; track message.id) {
                      <div class="flex w-full" [ngClass]="alignment(message.role)">
                        <div class="agent-panel__timeline-item">
                          <p class="agent-panel__timeline-meta">
                            {{ message.author }} · {{ message.time }}
                          </p>
                          <div class="agent-panel__timeline-bubble" [ngClass]="bubbleClasses(message.role)">
                            <span [innerHTML]="message.text | markdown"></span>
                          </div>
                        </div>
                      </div>
                    }
                  }
                </div>
              </div>
            } @else if (showAgentAiChat) {
              <div class="agent-panel__section agent-panel__section--chat">
                <div
                  #agentAiChatContainer
                  class="agent-panel__chat-log muted-scrollbar"
                  data-agent-ai-chat
                  style="overscroll-behavior: contain; -webkit-overflow-scrolling: touch;"
                >
                  @if (agentAiThread.length) {
                    @for (message of agentAiThread; track message.id) {
                      <div class="flex w-full" [ngClass]="agentAiAlignment(message.role)">
                        <div class="agent-panel__chat-item">
                          <p class="agent-panel__timeline-meta">
                            {{ message.author }} · {{ message.time }}
                          </p>
                          <div class="agent-panel__chat-bubble" [ngClass]="agentAiBubbleClasses(message.role)">
                            <span [innerHTML]="message.text | markdown"></span>
                          </div>
                        </div>
                      </div>
                    }
                  }

                  @if (isAgentAiThinking) {
                    <div class="flex w-full justify-start text-left">
                      <div class="agent-panel__chat-item">
                        <p class="agent-panel__timeline-meta">
                          {{ assistantName }} • AI Assistant
                        </p>
                        <div
                          class="agent-panel__chat-bubble"
                          [ngClass]="agentAiBubbleClasses('ai_agent')"
                          role="status"
                          aria-live="polite"
                        >
                          <div class="typing-indicator">
                            <span class="typing-indicator__label">Agent Thinking</span>
                            <span class="typing-indicator__dots" aria-hidden="true">
                              <span class="typing-indicator__dot"></span>
                              <span class="typing-indicator__dot"></span>
                              <span class="typing-indicator__dot"></span>
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  }
                </div>

                <div class="agent-panel__composer-wrapper">
                  <div class="agent-panel__composer">
                    <div class="agent-panel__composer-meta">
                      <span>Ask the AI assistant</span>
                    </div>
                    <div class="agent-panel__composer-input">
                      <textarea
                        rows="3"
                        placeholder="Ask {{ assistantName }} for guidance..."
                        [ngModel]="agentComposerInput"
                        (ngModelChange)="agentComposerInputChange.emit($event)"
                        (keydown.enter)="handleAgentEnter($event)"
                        [disabled]="!showAgentPanel"
                        class="agent-panel__textarea"
                      ></textarea>
                      <button
                        type="button"
                        aria-label="Send AI collaboration message"
                        (click)="sendAgentMessage.emit()"
                        [disabled]="!canSendAgentAiMessage"
                        class="agent-panel__send-button"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" class="h-5 w-5">
                          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 12.5 19.5 4 15 20l-3.2-6.4L4 12.5Z" />
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            } @else {
              <div class="agent-panel__placeholder">
                <p>Select a workspace view to get started.</p>
              </div>
            }
          </section>
        </div>
      }
    </div>
  </div>
</article>
